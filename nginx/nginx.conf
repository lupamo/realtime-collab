events {
	worker_connections 1024;
}

http {
	upstream auth_service {
		server auth-service:8000;
	}

	upstream task_service {
		server task-service:8001;
	}

	upstream websocket_service {
		server websocket-service:8002;
	}

	upstream frontend {
		server frontend:3001;
	}

	#Rate limiting 
	limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/m;
	limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/m;
	
	server {
		listen 80;
		server_name localhost;

		#increase buffer sizes for large headers (JWT tokens)
		proxy_buffer_size 128k;
		proxy_buffers 4 256k;
		proxy_busy_buffers_size 256k;

		#auth endpoints
		location /api/auth {
			limit_req zone=auth_limit burst=5;
			rewrite ^/api/(.*)$ /$1 break;
			proxy_pass http://auth_service;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		#task endpoints
		location /api/tasks {
			limit_req zone=api_limit burst=20;
			rewrite ^/api/(.*)$ /$1 break;
			proxy_pass http://task_service;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}
		location /api/projects {
			limit_req zone=api_limit burst=20;
			rewrite ^/api/(.*)$ /$1 break;
			proxy_pass http://task_service;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		location /api/teams {
			limit_req zone=api_limit burst=20;
			rewrite ^/api/(.*)$ /$1 break;
			proxy_pass http://task_service;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		#websocket endpoint
		location /ws/ {
			proxy_pass http://websocket_service;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			#webSocket timeouts settings
			proxy_read_timeout 86400s;
			proxy_send_timeout 86400s;
		}

		#Frontend (Next.js)
		location / {
			proxy_pass http://frontend;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;

			#websocket support for Next.js HMR
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
		}

		#Health check endpoint
		location /health {
			access_log off;
			return 200 "healthy\n";
			add_header Content-Type text/plain;
		}
	}
}
